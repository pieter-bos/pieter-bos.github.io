<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>VerCors Development Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="overview.html">Overview</a></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">1.</strong> Techical Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setup-workflow.html"><strong aria-hidden="true">1.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="setup-language.html"><strong aria-hidden="true">1.2.</strong> Language</a></li><li class="chapter-item expanded "><a href="setup-build-system.html"><strong aria-hidden="true">1.3.</strong> Build System</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.4.</strong> Libraries</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">1.4.1.</strong> ANTLR</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.4.2.</strong> Logback</div></li></ol></li></ol></li><li class="chapter-item expanded "><a href="col.html"><strong aria-hidden="true">2.</strong> Common Object Language</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="col-nodes.html"><strong aria-hidden="true">2.1.</strong> Nodes</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> References</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Origins</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> Checking</div></li><li class="chapter-item expanded "><a href="col-coercion.html"><strong aria-hidden="true">2.5.</strong> Coercion</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.6.</strong> Pretty-Printing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.7.</strong> Comparing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.8.</strong> Serialization</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Resolution</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Rewriting</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> Dispatch</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Generations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.</strong> Succesion</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.4.</strong> Blames</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.5.</strong> Nested Rewriters</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.6.</strong> Substitution</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.7.</strong> RewriteHelper</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.8.</strong> RewriteBuilder</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Backend and Errors</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Program Translation</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.</strong> Error Translation</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Utilites</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Caching</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Profiling and Progress</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Importing</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">VerCors Development Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>VerCors is a tool that tries to show programs to be correct. Correct may mean that the program finishes, that it does not crash, that it never throws an exception, or returns the correct result subject to some specification.</p>
<p>VerCors accepts programs in a variety of languages. For each language (also: <em>frontend</em>) the grammar is altered slightly, maintaining compatiblity with the source langauge grammar, so that we may add various annotations to the program. These annotations aid in verifying the program by specifying behaviour about it. This is crucial in automating the proof of the program.</p>
<p>As a tool VerCors works by passing the program through a large number of transformations. In general each transformation reduces the number of <em>features</em> in the program. You may think about features as different kinds of statements and operators. Various concerns are maintained in each element of the transformation. The most important guarded invariant is that of error transformations. As statement \(P\) is compiled into a different statement \(Q\), we have to remember how to translate errors about statement \(Q\) back into errors about statement \(P\).</p>
<p>An intermediate program is stored in VerCors as an <em>Abstract Syntax Tree</em> (short: AST). The internal language is also referred to as the <em>Common Object Language</em> (short: COL). Each part of the transformation is structured as a <em>Rewriter</em>, which visits each element in the AST. After visiting a node in the tree, the rewriter must specify what that node is replaced with. By default, the rewriter will recurse further into the tree, keeping the kind of node the same. For example, if we ask a default rewriter what \(p + q\) must be rewritten to, we will then ask what \(p\) and \(q\) will rewrite to. Supposing they rewrite to \(p'\) and \(q'\) respectively, the rewriter will by default restore the plus operator and return \(p' + q'\).</p>
<p>Around the transformation chain there are several steps. Unfortunately, syntax trees do not fall out of thin air, so we must first parse our text input into a tree. In VerCors, this is largely handled by by the ANTLR parser generator. We translate parse trees into COL trees as a part of the parsing stage, but there are no surprises there: as a matter of principle there is a corresponding COL node for each parse node. Next there is resolution: the process of associating each name in the tree with a referrable node. For example, variable names 'point' to the declaration of the variable. This stage usually presupposes that the file compiles at all.</p>
<p>After all the transformations we have a very simple program. On the other hand, proving it to be correct is no simple matter. We delegate this responsibility to Viper, a tool designed to automatically verify this dialect of program. Finally, a (hopefully empty) list of errors from Viper is translated into appropriate errors for the initial input to VerCors.</p>
<p>This completes the intended cycle of usage for VerCors: submitting a program to VerCors leads to a list of suggested improvements, which leads to editing the program, which leads to a new submission to VerCors. We have some qualitative wishes here: errors should be clear, specific and not a false negative. It should include context where appropriate, such as an example of how the error might occur. Ideally, VerCors is performant and can quickly establish whether or not there is an error.</p>
<p>The central goal is that we can encourage writers of critical software to prove their programs to be correct, so that their software is reliable.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="techical-setup"><a class="header" href="#techical-setup">Techical Setup</a></h1>
<p>This chapter describes some of the technical setup around vercors, like version control, programming language choice, and libraries. It can be referred back to when evaluating changes to the setup.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="workflow"><a class="header" href="#workflow">Workflow</a></h1>
<p>Since VerCors is made by Real Humans™ we agreed on some administrative conventions to stick by:</p>
<ul>
<li>If you have a bug or clearly delineated feature request, it should exist as an issue on our tracker on GitHub: <a href="https://github.com/utwente-fmt/vercors/issues">https://github.com/utwente-fmt/vercors/issues</a>. The goal is to have zero issues: that should be achievable, since it should be clear what to do from the issue.</li>
<li>If you have a more vague feature request, or a question, or you're not sure if something is a bug, it should be a discussion: <a href="https://github.com/utwente-fmt/vercors/discussions">https://github.com/utwente-fmt/vercors/discussions</a>.</li>
<li>If you're working on VerCors code longer term, we prefer that you do so in a <em>branch</em> in the main repository, rather than working in a fork. Please ask for push access when starting out.</li>
<li>If you're working on a single issue, please assign yourself the issue. </li>
<li>We use feature branches and pull requests, so once you're done please file a pull request. Contiuous integration will run all examples on your changes automatically, so it's wise to check if it succeeded.</li>
<li>We do not have a linting policy at this time. We ask that try to follow local conventions of files you're editing and do not reformat whole files.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="language"><a class="header" href="#language">Language</a></h1>
<p>VerCors is a JVM project, and the current main language we use is Scala. We do accept contributions in both Scala and Java, but we highly encourage you to learn some Scala before contributing.</p>
<p>Since the main backend of VerCors is currently Viper, we enjoy the benefit of calling into it directly and being able to debug it directly, since VerCors is also a JVM application.</p>
<p>We primarily develop VerCors in Scala for several reasons:</p>
<ul>
<li>Scala has great support for functional programming paradigms. VerCors primarily deals with immutable data-structures and pushes out effects, like logging verification failures and writing out files.</li>
<li>Scala supports pattern matching, which is very suitable for analysing ASTs.</li>
<li>Scala supports metaprogramming, which is very handy for generating functionality that recurses into the ASTs: rewriters, comparators, etc.</li>
<li>Other nice to haves: good collection api (sequences, sets), optional structural equality, sealed types.</li>
</ul>
<p>On the surface it seems Kotlin has significant feature overlap with Scala, but some of the above points are not available and are important. We may revisit that stance in the future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-system"><a class="header" href="#build-system">Build System</a></h1>
<p>The default build system for Scala, and hybrid Scala/Java project, is SBT. However, our current build system is <a href="https://mill-build.com/">mill</a>. For a general overview of why we don't use SBT anymore, see <a href="http://www.lihaoyi.com/post/SowhatswrongwithSBT.html">here</a>. </p>
<p>For us specifically we considered these things:</p>
<ul>
<li>For meta-build alterations in ColHelper, it was annoying to remember that you need to reload.</li>
<li>You needed to alter the IntelliJ settings immediately, otherwise the project does not build by default.</li>
<li>The run script broke for almost every user, because we use a custom classpath caching solution, because sbt &quot;run example.pvl&quot; starts up way too slow (~7 seconds when vercors is already entirely compiled).</li>
<li>Most people had encountered a situation where the project just breaks, and you need to re-import everything.</li>
<li>Anything custom was hard to implement, because we didn't understand enough about how sbt works.</li>
</ul>
<p>Mill on the other hand does not have these drawbacks:</p>
<ul>
<li>It is almost just scala.</li>
<li>Tasks are a straightforward and easy abstraction:
<ul>
<li>Custom stuff is easy to implement, even when interacting with mill internals.</li>
<li>Caching is essentially free due to the data model.</li>
<li>Tooling around mill is easy, because the hierarchy in the build definition corresponds to the hierarchy in <code>out</code>.</li>
<li>You can chain tasks entirely as you like and mill is fine with it: e.g. <code>col.generatedSources</code> depends on <code>colMeta.meta.runClasspath</code>.</li>
</ul>
</li>
<li>Mill boots with the vercors build in under one second, e.g. <code>time ./mill -j 0 vercors.runScript</code> -&gt; <code>real 0m0,753s</code>
<ul>
<li>This means we can finally get rid of our own classpath abstraction: we can be sure vercors runs normally every time.</li>
</ul>
</li>
<li>Mill seems to work well with IntelliJ via the BSP integration, which does not need any altered settings in IntelliJ.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common-object-language"><a class="header" href="#common-object-language">Common Object Language</a></h1>
<p>The Common Object Language (short: COL) is the intermediate representation of VerCors. The main component of VerCors is to apply a sequence of transformations (rewriters) to the COL tree until it is suitable to submit to a backend. This chapter describes concepts around the structure of COL.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nodes"><a class="header" href="#nodes">Nodes</a></h1>
<p>COL programs are stored in a tree-like immutable data structure. All nodes are defined in <code>src/col/vct/col/ast/Node.scala</code>. Other than some primitive types and collection types like <code>Int</code>, <code>String</code>, <code>Seq[_]</code> and tuples <code>(_, _)</code>, all types in the tree are descendants of <code>Node</code>.</p>
<p>Nodes are split into two kinds:</p>
<ul>
<li><strong>Descendants of <code>NodeFamily</code></strong>. These are regular nodes, like expressions and statements. 
<ul>
<li>They have structural equality, meaning comparing them constitutes comparing their fields. </li>
<li>It makes sense to say that each family of nodes should rewrite to itself: one <code>Statement</code> should always be rewritten to another <code>Statement</code>.</li>
</ul>
</li>
<li><strong>Descendants of <code>Declaration</code></strong>. These are nodes to which we can refer.
<ul>
<li>They have reference equality, which means a <code>new Variable(TInt) != new Variable(TInt)</code>.</li>
<li>It make sense to ask in which scope the declaration can be referred to. For example, a reference to an argument makes no sense outside the method it is declared in.</li>
<li>We should be able to rewrite a declaration to zero, one or more successors of itself.</li>
</ul>
</li>
</ul>
<p>We will not exhaustively describe all kinds of node here, but we highlight the ones that have special Properties.</p>
<h2 id="expr"><a class="header" href="#expr">Expr</a></h2>
<p>All expressions have a type:</p>
<pre><code class="language-scala">trait ExprImpl[G] { this: Expr[G] =&gt;
	def t: Type[G]
}
</code></pre>
<p>You may presume that the node is <code>check</code>ed before its type is queried, and may crash otherwise. The type of expressions is closely related to coercion.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coercion"><a class="header" href="#coercion">Coercion</a></h1>
<p>Various nodes contain expressions, such as other expressions (e.g. <code>Plus</code> contains its two arguments) and non-expressions (e.g. <code>Branch</code> contains the conditions for its branches). Each expression position in the tree may induce a typing constraint on the expression in it. For example, the conditions in <code>Branch</code> have to be booleans:</p>
<pre><code class="language-scala">case Branch(branches) =&gt; 
	Branch(branches.map { case (cond, effect) =&gt; (bool(cond), effect) })
</code></pre>
<p>and the arguments of <code>Plus</code> may be integers or rationals:</p>
<pre><code class="language-scala">case Plus(left, right) =&gt;
	firstOk(e, s&quot;Expected both operands to be numeric, but got ${left.t} and ${right.t}.&quot;,
		Plus(int(left), int(right)),
		Plus(rat(left), rat(right)),
	)
</code></pre>
<p>Here we coerce each <code>cond : Expr[G]</code> into a boolean, and do nothing with <code>effect</code>. For <code>Plus</code> we pick the first of two transformations that succeeds: either both <code>left</code> and <code>right</code> can be coerced with <code>int</code>, or both can be coerced with <code>rat</code>.</p>
<p>Coercions serve two purposes: they check that the AST is well-typed, and can be used in <code>Rewriter</code>s to enact transformations on the AST.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
