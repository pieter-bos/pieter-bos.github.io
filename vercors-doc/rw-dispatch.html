<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dispatch - VerCors Development Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="overview.html">Overview</a></li><li class="chapter-item expanded "><a href="start.html"><strong aria-hidden="true">1.</strong> Quick Reference Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="start-language.html"><strong aria-hidden="true">1.1.</strong> Adding a Language</a></li><li class="chapter-item expanded "><a href="start-spec.html"><strong aria-hidden="true">1.2.</strong> New specifications</a></li><li class="chapter-item expanded "><a href="start-mode.html"><strong aria-hidden="true">1.3.</strong> New modes</a></li></ol></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.</strong> Techical Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setup-workflow.html"><strong aria-hidden="true">2.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="setup-language.html"><strong aria-hidden="true">2.2.</strong> Language</a></li><li class="chapter-item expanded "><a href="setup-build-system.html"><strong aria-hidden="true">2.3.</strong> Build System</a></li></ol></li><li class="chapter-item expanded "><a href="col.html"><strong aria-hidden="true">3.</strong> Common Object Language</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="col-nodes.html"><strong aria-hidden="true">3.1.</strong> Nodes</a></li><li class="chapter-item expanded "><a href="col-ref.html"><strong aria-hidden="true">3.2.</strong> References</a></li><li class="chapter-item expanded "><a href="col-origin.html"><strong aria-hidden="true">3.3.</strong> Origins</a></li><li class="chapter-item expanded "><a href="col-check.html"><strong aria-hidden="true">3.4.</strong> Checking</a></li><li class="chapter-item expanded "><a href="col-coercion.html"><strong aria-hidden="true">3.5.</strong> Coercion</a></li><li class="chapter-item expanded "><a href="col-pp.html"><strong aria-hidden="true">3.6.</strong> Pretty-Printing</a></li><li class="chapter-item expanded "><a href="col-compare.html"><strong aria-hidden="true">3.7.</strong> Comparing</a></li><li class="chapter-item expanded "><a href="col-serialize.html"><strong aria-hidden="true">3.8.</strong> Serialization</a></li></ol></li><li class="chapter-item expanded "><a href="resolution.html"><strong aria-hidden="true">4.</strong> Resolution</a></li><li class="chapter-item expanded "><a href="rw.html"><strong aria-hidden="true">5.</strong> Rewriting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rw-outline.html"><strong aria-hidden="true">5.1.</strong> Outline</a></li><li class="chapter-item expanded "><a href="rw-dispatch.html" class="active"><strong aria-hidden="true">5.2.</strong> Dispatch</a></li><li class="chapter-item expanded "><a href="rw-generation.html"><strong aria-hidden="true">5.3.</strong> Generations</a></li><li class="chapter-item expanded "><a href="rw-succession.html"><strong aria-hidden="true">5.4.</strong> Succession</a></li><li class="chapter-item expanded "><a href="rw-blame.html"><strong aria-hidden="true">5.5.</strong> Blames</a></li><li class="chapter-item expanded "><a href="rw-nested.html"><strong aria-hidden="true">5.6.</strong> Nested Rewriters</a></li><li class="chapter-item expanded "><a href="rw-substitution.html"><strong aria-hidden="true">5.7.</strong> Substitution</a></li></ol></li><li class="chapter-item expanded "><a href="backend.html"><strong aria-hidden="true">6.</strong> Backend and Errors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="backend-translation.html"><strong aria-hidden="true">6.1.</strong> Program Translation</a></li><li class="chapter-item expanded "><a href="backend-error.html"><strong aria-hidden="true">6.2.</strong> Error Translation</a></li></ol></li><li class="chapter-item expanded "><a href="util.html"><strong aria-hidden="true">7.</strong> Utilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="util-cache.html"><strong aria-hidden="true">7.1.</strong> Caching</a></li><li class="chapter-item expanded "><a href="util-progress.html"><strong aria-hidden="true">7.2.</strong> Profiling and Progress</a></li><li class="chapter-item expanded "><a href="util-import.html"><strong aria-hidden="true">7.3.</strong> Importing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">VerCors Development Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dispatch"><a class="header" href="#dispatch">Dispatch</a></h1>
<p>A rewriter describes how a COL tree is transformed. The root of the tree is passed to one of the <code>dispatch</code> methods: each <code>dispatch</code> method decides what should happen next. By default we always recurse into the tree, querying <code>dispatch</code> for the child nodes of our current node. You might imagine that the default implementation of <code>dispatch</code> for a <code>Plus</code> node is structured like this:</p>
<pre><code class="language-scala">def dispatch(e: Expr[Pre]): Expr[Post] =
  e match {
    case Plus(left, right) =&gt;
      Plus(dispatch(left), dispatch(right))(e.o)

    /* ... other alternatives ... */
  }
</code></pre>
<h2 id="structural-transformations"><a class="header" href="#structural-transformations">Structural transformations</a></h2>
<p>The idea is now that you override dispatch methods for the nodes you would like to rewrite. For example, we might want to make an optimization that simplifies away additions of <code>0</code>:</p>
<pre><code class="language-scala">val ZERO = BigInt(0)

override def dispatch(e: Expr[Pre]): Expr[Post] =
  e match {
    case Plus(IntegerValue(ZERO), e) =&gt; dispatch(e)
    case Plus(e, IntegerValue(ZERO)) =&gt; dispatch(e)

    case other =&gt; other.rewriteDefault()
  }
</code></pre>
<p>A new concept here is <code>rewriteDefault</code>: it is the mechanism used to peel off one layer of a program tree and recurse into its children using dispatch. It is automatically generated for each node, here in <code>PlusRewrite</code>. It takes an implicit value of type <code>AbstractRewriter</code>, which is the rewriter used to call <code>dispatch</code> again. By default it picks the <code>implicit val rewriter</code> which is defined for each <code>AbstractRewriter</code>. Note that Scala requires that a match statement is complete. A default case as above also makes the match complete.</p>
<p>A common mistake is to erroneously call <code>rewriteDefault</code> too often: when recursing into nodes yourself you should almost always call <code>dispatch</code>, which will decide to do with the sub-node.</p>
<h2 id="transforming-declarations"><a class="header" href="#transforming-declarations">Transforming Declarations</a></h2>
<p><em>See also: <a href="./rw-succession.html">Succession</a></em></p>
<p>Declarations are special because it is not required that a declaration is transformed into a declaration. This is also represented in the signature of the <code>dispatch</code> method for <code>Declaration[_]</code>:</p>
<pre><code class="language-scala">def dispatch(decl: Declaration[Pre]): Unit
</code></pre>
<p>Nevertheless declarations have to be placed in the tree, and references to declarations need to be rewritten. Both are arranged through an instance of the <code>Scopes</code> class â€” one for each kind of declaration. Rewriting references is tricky, so this is explained later on in the section on <a href="./rw-succession.html">succession</a>.</p>
<p>A node that contains declaration, such as <code>Class[G](decls: Seq[ClassDeclaration[G]], ...)</code>, needs to come up with a new list of <code>ClassDeclaration[G]</code>. We first have to consider the appropriate <code>Scopes</code> instance: in this case <code>classDeclarations</code>. We call <code>classDeclaration.collect</code>, which pushes a collection buffer onto a stack. A lambda is passed to <code>collect</code> in which we can take any actions, chiefly to declare declarations of kind <code>ClassDeclaration</code>. By convention we call <code>dispatch</code> on all the <code>Pre</code>-state declarations that we are interested in, and (optionally) we can declare one or more other <code>ClassDeclaration</code>s we need to add. All this is also allowed to happen recursively: we can be in a statement somewhere in the class and still declare a helper method to the <code>classDeclarations</code> scope.</p>
<p>Combining this information we can obtain the new declarations of a class as such:</p>
<pre><code class="language-scala">val newDeclarations = classDeclarations.collect {
  cls.decls.foreach(dispatch)
}._1
</code></pre>
<p>Collect returns a tuple: a list of new declarations, and whatever the result of the lambda is (here: <code>Unit</code>). On the other side of the fence, the old class declarations are rewritten and declared to the scope. Reproducing the default behaviour for <code>ClassDeclaration</code>s might look like this, skipping over succession for the moment:</p>
<pre><code class="language-scala">override def dispatch(decl: Declaration[Pre]): Unit =
  decl match {
    case decl: ClassDeclaration[Pre] =&gt;
      classDeclarations.declare(decl.rewriteDefault())

    case other =&gt;
      allScopes.anyDeclare(other.rewriteDefault())
  }
</code></pre>
<p>Our friend <code>rewriteDefault</code> makes another appearence, which peels off the <code>ClassDeclaration</code> constructor, and recurses into its components. In the case that a <code>ClassDeclaration</code> contains further declarations, it will call <code>collect</code> again in a similar way. For example, an <code>InstanceMethod</code> is a <code>ClassDeclaration</code> and contains declarations of kind <code>Variable</code> for its arguments.</p>
<p>After rewriting the declaration fully by opting to rewrite it in a one-to-one manner, it is declared to the buffer of <code>ClassDeclaration</code>s that we are currently collecting.</p>
<p>Lastly we must always complete the match, which is done by also rewriting other declarations one-to-one, and using <code>allScopes</code> to find the correct scope to put the declaration in.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="rw-outline.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="rw-generation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="rw-outline.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="rw-generation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
